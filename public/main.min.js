!function(){"use strict";function e(e,t){var s=parseInt(e.slice(1),16),i=t<0?0:255,a=t<0?-1*t:t,n=s>>16,o=s>>8&255,r=255&s;return"#"+(16777216+65536*(Math.round((i-n)*a)+n)+256*(Math.round((i-o)*a)+o)+(Math.round((i-r)*a)+r)).toString(16).slice(1)}function t(e,t,s){["","-webkit-","-moz-","-ms-","-o-"].forEach(i=>e.style[t]=i+s)}function s(e){return e&&"function"==typeof e.then}function i(e){return e=Array.prototype.slice.call(e),!Array.isArray(e)||"function"!=typeof e.reduce||e.length<1?Promise.reject("err"):1==e.length?"function"!=typeof e[0]?Promise.reject("err "):Promise.resolve(e[0]()):e.reduce(function(t,i){if(t==e[0]){if("function"!=typeof t)return Promise.reject("err");var a=t();return s(a)?a.then(i):Promise.reject("err")}if(s(t))return t.then(i);Promise.reject("err")})}const a=(e,t=document.body)=>Array.isArray(e)?e.forEach(e=>a(e,t)):t.appendChild(e),n=(e,t={},...s)=>{const i=document.createElement(e),n=(e,t)=>{if(e instanceof Element)a(e,t);else{if(!e)return;let s=document.createTextNode(e);a(s,t)}};if("string"==typeof t)i.className=t;else{const{className:e,bs:s,top:a,left:n,width:o,height:r,background:c}=t;i.className=e||"pix",i.style.background=c||"",i.style.top=a||"",i.style.left=n||"",i.style.width=o||"",i.style.height=r||"",i.style.boxShadow=s||""}return s.length&&(Array.isArray(s[0])&&(s=s[0]),s.forEach(e=>{Array.isArray(e)?e.forEach(e=>n(e,i)):n(e,i)})),i.prependChild=(e=>i.insertBefore(e,i.firstChild)),i.$m=(e=>a(e,i)),i.hide=(()=>i.style.display="none"),i.show=((e="inherit")=>i.style.display=e),i.html=(e=>i.innerHTML=e),i.empty=(()=>i.html("")),i.on=((e,t)=>i.addEventListener(e,t)),i.click=(e=>{if(e)i.on("click",e);else{const e=document.createEvent("MouseEvents");e.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(e)}}),i.change=(e=>i.on("change",e)),i},o=(t,s="#080",i=0,a=0,o=8,r=!1,c=-.05)=>{try{let l=e=>e%o<e/o-1,h=t.split("").reduce((e,t)=>e+("000"+parseInt(t,16).toString(2)).substr(-4,4),"").split("").reduce((t,i,a)=>t+(parseInt(i)?`${a%o}em ${a/o|0}em ${r&&l(a)?e(s,c):s},`:""),"").slice(0,-1);return n("div",{bs:h,className:"pix",left:i+"em",top:a+"em"})}catch(e){return}},r="3f7fffdfdfdfdfdfdfdfdfdfdf",c="1c1c1c1c1c1c1c1c1c1c1c7c7c",l="1c1c1c1c1c1c1c1c1c1c1c1f1f";var h=Object.freeze({a:"183c66667e7e6642",armor:"0044eceefefefefe7ceeee",axe:"0416173f3f171614101010",b:"7c66667e6466667c",bodyleft:r,bodyright:"fcfefffbfbfbfbfbfbfbfbfbfb",c:"3c6260606060623c",colon:"0000006060006060",comma:"0000000000303060",d:"7c6666666666667c",dot:"0000000000006060",e:"7e60607c7c60607e",exc:"1818181818001818",f:"7e60607c7c606060",g:"7e6260606e66667e",h:"6666667e7e666666",hair1:"7f7fc0c0",hair2:"3c7effe3c1c0",head:"7efefefefee0",heart:"48fcfc7830",hemlet:"003e7efee0f2f2f2",i:"7e7e181818187e7e",j:"0606060666667e7e",k:"66666c78786c6666",l:"6060606060607e7e",legleft:c,legright:l,longhat:"787878fcfc",m:"4163777f7f6b6363",n:"63737b7f7f6f6763",n0:"3c6262626262623c",n1:"387818181818187e",n2:"3c7e660c1830627e",n3:"3c66460c0c46663c",n4:"2c6c6c6c7f0c0c0c",n5:"7e6060607e06467e",n6:"7e6060607e62627e",n7:"7e6606060c0c1818",n8:"3c66663c6666663c",n9:"3c4646463e06463c",o:"3c6666666666663c",p:"3c666666667c6060",q:"3c424242424a463d",qes:"3c66460e1c180018",r:"7c62627c786c6663",rect:"70707070",s:"3c626230184e463c",shorthat:"3cffff",slash:"0c0c181830306060",sword:"10101010101010387c1010",t:"7e7e181818181818",triangle:"183c7eff",u:"6666666666667e3c",v:"4266666666663c18",w:"6363636b7f7f7763",x:"6363363e1c367763",y:"6666667e3c181818",z:"7e7e0e1c38707e7e"});const m=(e,t,s,i="px")=>{e.style.left="50%",e.style.top="50%",e.style.marginLeft=`-${t/2+i}`,e.style.marginTop=`-${s/2+i}`},p=(e,t=1,s=1,i=0,a=0,n=0)=>e.style.transform=`rotate(${n}deg) scale(${t}, ${s}) translate(${i}em, ${a}em) translateZ(1000px)`,d=e=>()=>new Promise(t=>e(t)),{data:f}=DATA.OBJS;console.log("objs",f);const u={get:(e,t=!1)=>{let s=f[e],i=s[2].reverse().map(e=>{let t=Array.isArray(e[1])?random(e[1]):e[1],s=o(h[e[0]],t,e[2],e[3],8,!0);return p(s,e[4],e[5],e[6],e[7]),s}),a=n("div",{className:"pix obj",height:s[0]+"em",width:s[1]+"em"},i);return t&&a.prependChild(n("div","shadow")),p(a,s[3],s[4],s[5],s[6],s[7]),{el:a,size:[s[1],s[0]]}},text:(e,t="#fff",s={})=>(e=e.toLowerCase(),n("div",Object.assign({},{className:"pix text",height:"8em",width:8*e.length+"em"},s),e.split("").map((e,s)=>{let i={".":"dot",",":"comma","!":"exc","?":"qes",":":"colon","/":"slash"};return e in i&&(e=i[e]),/^\d+$/.test(e)&&(e="n"+e)," "==e?n("div",{width:"1em"}):o(h[e],t,8*s)})))},g=e=>n("div","dialog-inner popup",e||null),y=e=>{let t=n("div","ui dialog");return t.$innerBox=g(e),a(t.$innerBox,t),t},b=(e,t,s,i=[],o="ok")=>{let r=y([u.text(e)]);return i.length>0||(i=v(o)).click(()=>{s(),r.hide()}),a([n("div","dialog-content",t),i],r.$innerBox),r},v=(e,t)=>n("div",t||"btn blue",u.text(e));var k={button:v,dialog:y,progress:(e="",t=1,s=10,i=70,a=100,o="red")=>{let r=a;const c=n("div",{className:"progress-bar",background:o}),l=u.text(`${e}:${i}/${a}`,"#fff"),h=n("div",{className:"progress",width:s+"em",height:t+"em"},c,l),m=e=>{c.style.width=e/r*100+"%"};return m(i),{el:h,setVal:m,setMax:e=>r=e}},ask:(e,t)=>{let s="",i=n("input","input");return i.type="text",i.change(e=>s=e.target.value),b(e,i,()=>t(s))},pick:(e,t,s,i,a="")=>{let o=0,r=t.map((e,t)=>{let i=n("span",`ui option ${a}`,e);return i.click(()=>{s(o=t),r.forEach((e,t)=>e.style.border=o===t?"1px solid #fff":"none")}),i});return b(e,r,()=>i(o))},alert:(e,t,s)=>b(e,[],s,[],t),controls:e=>{const t=n("div","chat"),s=n("input","chat-input");s.type="text";const i=v("send","chat-btn");i.on("click",()=>{e(s.value),s.value=""});const o=n("div","chat-box",t,s,i);let r=!1;t.on("scroll",()=>r=!0),setInterval(()=>{r?t.scrollHeight-t.scrollTop===t.clientHeight&&(r=!1):t.scrollTop=t.scrollHeight},100);const c=n("div","status-box"),l=n("div","action-box");return{el:n("div","controls",o,c,l),logs:e=>{t.empty(),a(e.map(e=>n("p","",e)),t)},submitEl:i,actionBox:l,statusBox:c}},text:u.text,map:(e,t)=>{const{areas:s}=DATA.MAPS,i=[];let a=t,o=n("div","map-text"),r=n("div","map-detail"),c=n("div","map",o,r);e.forEach((e,t)=>{let a=n("div",{className:"map-row",width:e.length+"em",height:"1em"});i[t]=[],e.forEach((e,r)=>{let c=n("div",{className:`map-node`,width:"1em",height:"1em",background:s[e][4]});i[t][r]=c,c.on("mouseover",()=>{o.empty(),o.$m(u.text(`${s[e][1]} x:${r} y:${t}`)),o.show()}),a.$m(c)}),r.$m(a)}),r.on("mouseout",()=>o.hide());let l=b("map",c,()=>l.hide());return{el:l,update:e=>{a.y>-1&&(i[a.x][a.y].className="map-node"),i[e.x][e.y].className="map-node active",a=e}}},removeAll:e=>Array.prototype.forEach.call(document.getElementsByClassName(e),e=>e.parentNode.removeChild(e))};const{skins:x,hairs:w}=DATA.COLORS,E=(e,t,s=[])=>{const i=n("div","pix upAndDown",o(r,x[e],0,5.5,8,!0),o("fcfefffbfbfbfbfbfbfbfbfbfb",x[e],5,5.5),s.filter(e=>2===e.pos||3===e.pos).map(e=>e.el)),a=n("div",{},o(c,x[e],0,18,8,!0),o(l,x[e],4,18));return[n("div","pix upAndDown",o("7efefefefee0",x[e],4),o("3c7effe3c1c0",w[t],4,-3,8),s.filter(e=>1===e.pos).map(e=>e.el)),a,i]},$=(e,t=[],s=!1)=>{const i=n("div",{className:"",top:"-7em"},k.text(e.name)),o=t.map(e=>"string"==typeof e?n("div"):e.eq?{el:u.get(e.obj).el,pos:e.pos}:n("div"));let r=E(e.skin,e.hair,o);const c=n("div",{className:`character ${s?"rev":""}`,height:"31em",width:"13em"},i,n("div","shadow"),r);return{el:c,info:e,width:13,height:31,updateInfo:(t,s=[])=>{t.name!=e.name&&(i.html(""),e.name=t.name,a(k.text(e.name),i)),t.skin==e.skin&&t.hair==e.hair||(e.skin=t.skin,e.hair=t.hair,r.forEach(e=>c.removeChild(e)),r=E(e.skin,e.hair),a(r,c))},scale:e=>c.style.fontSize=e/100+"em",changePos:e=>{c.style.left=e[0]+"em",c.style.top=e[1]+"em"}}},A={t:42,l:15},N={b:[1,2,3,4,5].map(e=>[e*A.l+(e-1)*(1==e?0:5),A.t]),m:[1,2,3,4,5].map(e=>[10*e+(e-1)*(1==e?0:10),50]),f:[1,2,3,4,5].map(e=>[10*e+(e-1)*(1==e?0:10),70])},{grounds:C,sky:I}=DATA.COLORS,z=[(e=45)=>`linear-gradient(${e}deg, rgba(255, 255, 255, .2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .2) 50%, rgba(255, 255, 255, .2) 75%, transparent 75%, transparent)`,()=>""],O=[{size:"50px 50px",color:C[3],pattern:0},{size:"6px 102px",color:C[4],pattern:0},{size:"",color:I[0],pattern:1},{size:"",color:C[5],pattern:0},{size:"",color:"blue",pattern:0,opt:0}],S=(e,s="bottom")=>{let i=n("div",{className:s});return i.style.backgroundColor=e.color,t(i,"backgroundImage",z[e.pattern](e.opt)),i.style.backgroundSize=e.size,i},P=(e,t,s,i="")=>{function o(e,s=!1){e.forEach((e,t)=>{let i=$(e.info,e.status.items,s);i.scale(80),i.changePos(N.m[t+(s?3:0)]),s?c.push(i):r.push(i)}),s?a(c.map(e=>e.el),t):a(r.map(e=>e.el),t)}let r=[],c=[],l=e=>e.backEls.map((t,s)=>{if(t<0)return n("div");let i=N.b[s],a=u.get(e.backEls[t],!0),o=n("div",{className:"pix obj popup",left:i[0]+"em",top:i[1]-a.size[1]+"em"},a.el);return o.style.animationDelay=.1*s+"s",o});const h=e=>[S(O[e.back],"back"),S(O[e.bottom])];let m=n("div",{className:"stage"},h(e)),p=l(e);a(p,t),o(s);let d=n("div","env-name centerX",u.text(i));a(d,t);let f=n("div","env-overlay fadeInOut");f.hide();let g=n("div","env-overlay hp fadeInOut");return g.hide(),a([f,g],t),{el:m,changePlayers:function(e){r.forEach((e,s)=>{t.removeChild(e.el)}),r=[],o(e)},changeStage:function(e,s){f.show(),setTimeout(()=>f.hide(),1e3),m.empty(),m.$m(h(s.status.place.env)),d.empty(),d.$m(u.text(s.status.place.name)),o(s.status.place.monsters,!0),p.forEach(e=>t.removeChild(e)),p=l(s.status.place.env),a(p,t)},hurt:()=>{g.show(),setTimeout(()=>g.hide(),1e3)}}};class B{constructor(e){this.socket=e,this.init=!1,this.info={},this.game=null,this.width=1024,this.height=768,this.scale=10,this.character=null,this.stage=null,this.controls=null,this.statusui={},this.container=n("div",{className:"game",width:this.width+"px",height:this.height+"px"}),this.itemOpen=!1,this.initComm(e),this.resize(),this.err=!1}bindKeys(){document.onkeydown=(e=>{switch((e=e||window.event).which||e.keyCode){case 13:this.controls.submitEl.click()}})}home(){this.character=$(this.info),a(this.character.el,this.container),m(this.character.el,this.character.width,this.character.height,"em"),this.character.el.style.left="20%",a(this.container);const{skins:e,hairs:t}=DATA.COLORS,{stories:s}=DATA;i([d(e=>a(k.ask("your name",t=>this.emit("updateInfo",{name:t},()=>e())),this.container)),d(t=>a(k.pick("skin",e.map(e=>n("div",{className:"opt-color",background:e})),e=>this.emit("updateInfo",{skin:e}),e=>this.emit("updateInfo",{skin:e},()=>t())),this.container)),d(e=>a(k.pick("hair",t.map(e=>n("div",{className:"opt-color",background:e})),e=>this.emit("updateInfo",{hair:e}),t=>this.emit("updateInfo",{hair:t},()=>e())),this.container)),d(e=>a(k.alert(s[0],"start game",()=>this.emit("queueGame",{},()=>e()))))]).then(()=>console.log("waiting game"))}initGame(){console.log("Init game",this.game),this.player=this.game.players.find(e=>e.id==this.info.id),console.log("This Player",this.player),this.character.el.hide(),this.stage=P(this.game.lobby.env,this.container,this.game.players,this.game.lobby.name),this.controls=k.controls(e=>this.emit("gamemsg",e)),this.socket.on("gamemsg",e=>{this.controls.logs(this.game.logs=e)}),this.socket.on("changeStage",e=>{console.log("changesatege",e),this.player.status.loc=e.loc,this.player.status.place=e.place,this.stage.changeStage(this.game,this.player),this.stage.changePlayers(this.game.players),this.map.update(e.loc)}),this.socket.on("changePlayers",e=>{this.game.players=e,console.log("change paleyrs",e),this.stage.changePlayers(this.game.players)}),this.socket.on("gameinfo",e=>Object.assign(this.game,e)),this.bindKeys(),a(this.controls.el,this.container),a(this.stage.el,this.container),this.renderStatus(),this.renderActions()}renderStatus(){const e=()=>{let e=n("div","attrs");for(let t in this.player.status.attrs)"hp"===t?(this.statusui.hp=k.progress("hp",3,30,this.player.status.attrs[t]),a(this.statusui.hp.el,this.controls.statusBox)):a(k.text(`${t}: ${this.player.status.attrs[t]}`),e);return e};this.socket.on("changeAttr",t=>{console.log("new attr",t),this.controls.statusBox.empty(),t.hp<this.player.status.attrs.hp&&this.stage.hurt(),this.player.status.attrs=t,a(e(),this.controls.statusBox)})}renderActions(){this.controls.actionBox.empty(),k.removeAll("ui dialog");let e=k.button("map");this.map=k.map(this.game.map,this.player.status.loc,(e,t)=>console.log("map:",e,"-",t)),a(this.map.el),this.map.el.hide(),e.click(()=>this.map.el.show());let t=k.button("item");t.click(()=>{this.itemOpen=!0,this.itemEl.show()}),this.socket.on("changeItems",e=>{this.player.status.items=e;let t=k.pick("Items",this.player.status.items.map(e=>{let t="string"==typeof e?e:`${e.name}${e.grade>0?"+"+e.grade:""} ${e.eq?"[Equiped]":""}`,s=n("div",{className:"opt-item"},t);return s.style.color=grades[e.grade],s}),e=>this.emit("useitem",e),()=>this.itemOpen=!1,"items");a(t),this.itemEl?(this.itemEl.parentNode.removeChild(this.itemEl),this.itemEl=t):this.itemEl=t,this.itemOpen||this.itemEl.hide()});this.socket.on("changeActions",(s=[])=>{this.controls.actionBox.empty();const i={map:e};a(s.map(e=>{if(e in i)return i[e];{let t=k.button(e);return t.click(()=>this.emit("gameaction",e)),t}}).concat(t),this.controls.actionBox)})}emit(e,t,s){this.socket.emit(e,t,s)}initComm(e){e.on("initGame",e=>{this.game=e,this.initGame()}),e.on("updateInfo",e=>{this.info=e,this.init||(this.init=!0,this.home()),this.character.updateInfo(this.info)}),e.on("connect",e=>{}),e.on("disconnect",this.onErr),e.on("connect_error",this.onErr),e.on("error",this.onErr),e.on("gg",e=>this.onErr(e))}onErr(e){this.err||a(k.alert(e||"You are disconnected","ok",()=>window.location.reload(!0)))}resize(){m(this.container,this.width,this.height),this.container.style.fontSize=`${this.scale}px`}}t(document.body,"background","radial-gradient(ellipse at center, #b5bdc8 0%,#828c95 36%,#28343b 100%)");new B(io({upgrade:!1,transports:["websocket"]}))}();